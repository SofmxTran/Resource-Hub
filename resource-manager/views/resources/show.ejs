<%- include('../partials/head', { title }) %>
<%- include('../partials/navbar') %>
<div class="container py-4">
  <%- include('../partials/messages') %>
  <div class="row g-4">
    <div class="col-lg-8">
      <div class="card shadow-sm border-0 mb-4">
        <% if (resource.image_path) { %>
        <img
          src="/uploads/<%= resource.image_path %>"
          alt="Thumbnail"
          class="card-img-top"
          style="max-height: 300px; object-fit: cover;"
        />
        <% } %>
        <div class="card-body">
          <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
            <span class="badge <%= resource.type === 'FILE' ? 'bg-info text-dark' : 'bg-success' %>">
              <%= resource.type %>
            </span>
            <span class="badge <%= resource.is_public ? 'bg-success' : 'bg-secondary' %>">
              <%= resource.is_public ? 'Public' : 'Private' %>
            </span>
            <span class="badge <%= resource.status === 'APPROVED' ? 'bg-success' : resource.status === 'PENDING' ? 'bg-warning text-dark' : 'bg-danger' %>">
              <%= resource.status %>
            </span>
          </div>
          <h2 class="mb-1"><%= resource.title %></h2>
          <p class="text-muted mb-3">
            Posted by <strong>@<%= resource.username %></strong> on
            <%= new Date(resource.created_at).toLocaleDateString() %>
          </p>
          <p class="mb-3"><%= resource.description || 'No description provided.' %></p>
          <ul class="list-inline small text-muted mb-4">
            <li class="list-inline-item">
              Domain: <strong><%= resource.domain_name || 'Uncategorized' %></strong>
            </li>
            <% if (resource.purpose) { %>
            <li class="list-inline-item">• Purpose: <%= resource.purpose %></li>
            <% } %>
            <li class="list-inline-item">• Trust: <strong><%= resource.trust_score || 0 %></strong></li>
          </ul>
          <% if (resource.guide_text) { %>
          <div class="mb-4">
            <h5>Guide / Instructions</h5>
            <p class="guide-text" style="white-space: pre-line"><%= resource.guide_text %></p>
          </div>
          <% } %>
          <div class="d-flex flex-wrap gap-2">
            <% if (resource.type === 'FILE' && resource.file_path) { %>
            <a class="btn btn-outline-primary" href="/uploads/<%= resource.file_path %>" target="_blank">Download file</a>
            <% } %>
            <% if (resource.type === 'LINK' && resource.url) { %>
            <a class="btn btn-outline-primary" href="<%= resource.url %>" target="_blank">Open link</a>
            <% } %>
            <% if (currentUser) { %>
            <form action="/resources/<%= resource.id %>/vote" method="POST">
              <button class="btn <%= userVote ? 'btn-success' : 'btn-outline-success' %>">
                <%= userVote ? 'Trusted' : 'Trust this resource' %>
              </button>
            </form>
            <% } else { %>
            <span class="text-muted fst-italic">Login to trust this resource.</span>
            <% } %>
          </div>
        </div>
      </div>

      <div class="card shadow-sm border-0">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0">Comments (<%= comments.length %>)</h4>
            <% if (currentUser) { %>
            <span class="badge bg-secondary">Signed in as @<%= currentUser.username %></span>
            <% } %>
          </div>
          <% if (comments.length) { %>
          <div class="list-group mb-4">
            <% comments.forEach((comment) => { %>
            <div class="list-group-item">
              <div class="d-flex justify-content-between">
                <div>
                  <strong>@<%= comment.username %></strong>
                  <small class="text-muted ms-2"><%= new Date(comment.created_at).toLocaleString() %></small>
                </div>
                <% if (comment.rating) { %>
                <span class="badge bg-warning text-dark">⭐ <%= comment.rating %>/5</span>
                <% } %>
              </div>
              <p class="mb-2 mt-2"><%= comment.content %></p>
              <% if (currentUser && (currentUser.id === comment.user_id || currentUser.isAdmin)) { %>
              <form
                action="/resources/<%= resource.id %>/comments/<%= comment.id %>/delete"
                method="POST"
                onsubmit="return confirm('Delete this comment?')"
              >
                <button class="btn btn-sm btn-outline-danger">Delete</button>
              </form>
              <% } %>
            </div>
            <% }) %>
          </div>
          <% } else { %>
          <p class="text-muted">No comments yet. Be the first to share feedback.</p>
          <% } %>

          <% if (currentUser) { %>
          <form action="/resources/<%= resource.id %>/comments" method="POST">
            <div class="mb-3">
              <label class="form-label">Your feedback</label>
              <textarea
                name="content"
                class="form-control"
                rows="3"
                placeholder="What did you like or learn?"
                required
              ></textarea>
            </div>
            <div class="mb-3 col-md-4">
              <label class="form-label">Rating (optional)</label>
              <select class="form-select" name="rating">
                <option value="">No rating</option>
                <option value="5">5 - Excellent</option>
                <option value="4">4</option>
                <option value="3">3</option>
                <option value="2">2</option>
                <option value="1">1 - Needs work</option>
              </select>
            </div>
            <button class="btn btn-primary">Post comment</button>
          </form>
          <% } else { %>
          <p class="text-muted mb-0">Login to leave a comment or rating.</p>
          <% } %>
        </div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-body">
          <h5 class="card-title">At a glance</h5>
          <ul class="list-unstyled mb-0 small">
            <li><strong>Owner:</strong> @<%= resource.username %></li>
            <li><strong>Created:</strong> <%= new Date(resource.created_at).toLocaleDateString() %></li>
            <li><strong>Updated:</strong> <%= new Date(resource.updated_at).toLocaleDateString() %></li>
            <li><strong>Status:</strong> <%= resource.status %></li>
            <li><strong>Trust score:</strong> <%= resource.trust_score || 0 %></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>
<%- include('../partials/footer') %>

