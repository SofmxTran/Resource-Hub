<%- include('../partials/head', { title }) %>
<%- include('../partials/navbar') %>
<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <h4 class="mb-3">Edit Resource</h4>
          <%- include('../partials/messages') %>
          <form
            action="/resources/<%= resource.id %>/edit"
            method="POST"
            enctype="multipart/form-data"
          >
            <div class="mb-3">
              <label class="form-label">Title</label>
              <input
                type="text"
                class="form-control"
                name="title"
                value="<%= resource.title %>"
                required
              />
            </div>
            <div class="mb-3">
              <label class="form-label">Description</label>
              <textarea
                name="description"
                class="form-control"
                rows="3"
              ><%= resource.description || '' %></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Guide / Instructions</label>
              <textarea
                name="guideText"
                class="form-control"
                rows="4"
              ><%= resource.guide_text || '' %></textarea>
            </div>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Domain</label>
                <select name="domainId" class="form-select">
                  <option value="" <%= !resource.domain_id ? 'selected' : '' %>>
                    Uncategorized
                  </option>
                  <% domains.forEach((d) => { %>
                  <option
                    value="<%= d.id %>"
                    <%= resource.domain_id === d.id ? 'selected' : '' %>
                  >
                    <%= d.name %>
                  </option>
                  <% }) %>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Purpose</label>
                <% const purposeOptions = ['Study','Video Editing','Reference','Practice','Other']; %>
                <select name="purpose" class="form-select">
                  <option value="">Select</option>
                  <% purposeOptions.forEach((p) => { %>
                  <option
                    value="<%= p %>"
                    <%= resource.purpose === p ? 'selected' : '' %>
                  >
                    <%= p %>
                  </option>
                  <% }) %>
                </select>
              </div>
            </div>
            <div class="row g-3 mt-1">
              <div class="col-md-6">
                <label class="form-label">Type</label>
                <select
                  name="type"
                  class="form-select"
                  id="resourceType"
                  required
                >
                  <option value="FILE" <%= resource.type === 'FILE' ? 'selected' : '' %>>
                    File
                  </option>
                  <option value="LINK" <%= resource.type === 'LINK' ? 'selected' : '' %>>
                    Link
                  </option>
                  <option value="POST" <%= resource.type === 'POST' ? 'selected' : '' %>>
                    Post / Article
                  </option>
                </select>
              </div>
              <div class="col-md-6 file-field">
                <label class="form-label">Upload New File</label>
                <% if (resource.file_path) { %>
                <p class="small text-muted mb-1">
                  Current:
                  <a href="<%= resource.file_path && resource.file_path.includes('cloudinary.com') ? resource.file_path : '/uploads/' + resource.file_path %>" target="_blank"
                    ><%= resource.file_path %></a
                  >
                </p>
                <% } %>
                <input class="form-control" type="file" name="fileUpload" />
              </div>
            </div>
            <div class="mt-3 link-field <%= resource.type === 'FILE' || resource.type === 'POST' ? 'd-none' : '' %>">
              <label class="form-label">URL</label>
              <input
                type="url"
                class="form-control"
                name="url"
                value="<%= resource.url || '' %>"
              />
            </div>
            <div class="mt-3 post-field <%= resource.type !== 'POST' ? 'd-none' : '' %>">
              <label class="form-label">Content <span class="text-danger">*</span></label>
              <textarea
                name="content"
                class="form-control"
                id="postContent"
                rows="12"
                placeholder="Write your post/article content here. You can use basic HTML formatting."
                required
              ><%= resource.content || '' %></textarea>
              <small class="text-muted">
                <i class="fas fa-info-circle me-1"></i>You can use basic HTML tags like &lt;p&gt;, &lt;strong&gt;, &lt;em&gt;, &lt;ul&gt;, &lt;ol&gt;, &lt;li&gt;, &lt;a&gt;, &lt;img&gt;, etc.
              </small>
            </div>
            <div class="mt-3">
              <label class="form-label">Thumbnail image</label>
              <% if (resource.image_path) { %>
              <div class="mb-2">
                <img
                  src="<%= resource.image_path && resource.image_path.includes('cloudinary.com') ? resource.image_path : '/uploads/' + resource.image_path %>"
                  alt="Thumbnail"
                  class="img-fluid rounded"
                  style="max-height: 160px; object-fit: cover;"
                />
              </div>
              <% } %>
              <input class="form-control" type="file" name="imageUpload" accept="image/*" />
              <small class="text-muted">Uploading a new image replaces the old one.</small>
            </div>
            <div class="form-check form-switch mt-3">
              <input
                class="form-check-input"
                type="checkbox"
                name="isPublic"
                id="isPublic"
                <%= resource.is_public ? 'checked' : '' %>
              />
              <label class="form-check-label" for="isPublic">
                Public resource (shows on home feed)
              </label>
            </div>
            <p class="small text-muted mt-1">
              Current status: <strong><%= resource.status %></strong>. Public updates may require re-approval.
            </p>
            <div class="d-flex justify-content-between mt-4">
              <a href="/resources" class="btn btn-outline-secondary">Back</a>
              <button class="btn btn-primary">Update Resource</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const typeSelect = document.getElementById('resourceType');
    const fileField = document.querySelector('.file-field');
    const linkField = document.querySelector('.link-field');
    const postField = document.querySelector('.post-field');
    const postContent = document.getElementById('postContent');
    
    const toggleFields = () => {
      const type = typeSelect.value;
      const isFile = type === 'FILE';
      const isLink = type === 'LINK';
      const isPost = type === 'POST';
      
      fileField.classList.toggle('d-none', !isFile);
      linkField.classList.toggle('d-none', !isLink);
      postField.classList.toggle('d-none', !isPost);
      
      // Make content required only for POST type
      if (postContent) {
        postContent.required = isPost;
      }
    };
    
    if (typeSelect) {
      typeSelect.addEventListener('change', toggleFields);
      toggleFields();
    }
  });
</script>
<%- include('../partials/footer') %>

